<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gordpool Planner (WASM)</title>
  <style>
    :root {
      --bg: #0c0f12;
      --panel: #0f1724;
      --border: #1f2a3a;
      --text: #e3e8ef;
      --muted: #8ea0b7;
      --accent: #4f46e5;
      --input: #11161e;
    }
    body { font-family: "SFMono-Regular", Consolas, Menlo, monospace; margin: 24px; background: var(--bg); color: var(--text); }
    h1 { margin-top: 0; }
    p.lead { color: var(--muted); }
    .summary { color: var(--muted); font-size: 13px; margin: 8px 0 0; }
    .layout { display: grid; grid-template-columns: minmax(320px, 420px) 1fr; gap: 16px; align-items: start; margin-top: 16px; }
    .controls, .chart-panel { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
    form { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    label { display: flex; flex-direction: column; font-size: 12px; color: var(--muted); gap: 4px; }
    input, select { padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input); color: var(--text); }
    select { appearance: none; background-image: linear-gradient(45deg, transparent 50%, var(--muted) 50%), linear-gradient(135deg, var(--muted) 50%, transparent 50%); background-position: calc(100% - 16px) 50%, calc(100% - 10px) 50%; background-size: 6px 6px, 6px 6px; background-repeat: no-repeat; padding-right: 28px; }
    button { width: 100%; padding: 12px; border: none; border-radius: 8px; background: var(--accent); color: white; font-weight: 700; cursor: pointer; margin-top: 8px; }
    button:disabled { background: #2d3240; cursor: not-allowed; }
    .chart-panel pre { background: transparent; border: none; padding: 0; margin: 0; white-space: pre; overflow-x: auto; min-height: 260px; height: 70vh; }
    .chart-panel pre.empty { height: 220px; }
    .chart-panel pre span { font-weight: 600; }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .chart-panel { order: 1; }
      .controls { order: 2; }
      .chart-panel pre { height: 320px; }
    }
  </style>
</head>
<body>
  <h1>Gordpool Planner (WASM demo)</h1>
  <p class="lead">Shared logic via <code>pkg/planner</code> + <code>pkg/textchart</code>. Fill params and run; Go/WASM fetches Nordpool, builds the plan, and renders the same text chart used in the TUI.</p>

  <div class="layout">
    <div class="controls">
      <form id="planner-form">
        <label>Area
          <select name="area" class="flag-select">
            <option value="FI">ðŸ‡«ðŸ‡® Finland (FI)</option>
            <option value="SE1">ðŸ‡¸ðŸ‡ª Sweden North (SE1)</option>
            <option value="SE2">ðŸ‡¸ðŸ‡ª Sweden Central North (SE2)</option>
            <option value="SE3">ðŸ‡¸ðŸ‡ª Sweden Central (SE3)</option>
            <option value="SE4">ðŸ‡¸ðŸ‡ª Sweden South (SE4)</option>
            <option value="NO1">ðŸ‡³ðŸ‡´ Norway Oslo (NO1)</option>
            <option value="NO2">ðŸ‡³ðŸ‡´ Norway Kr.sand (NO2)</option>
            <option value="NO3">ðŸ‡³ðŸ‡´ Norway Tr.heim (NO3)</option>
            <option value="NO4">ðŸ‡³ðŸ‡´ Norway TromsÃ¸ (NO4)</option>
            <option value="NO5">ðŸ‡³ðŸ‡´ Norway Bergen (NO5)</option>
            <option value="DK1">ðŸ‡©ðŸ‡° Denmark West (DK1)</option>
            <option value="DK2">ðŸ‡©ðŸ‡° Denmark East (DK2)</option>
            <option value="EE">ðŸ‡ªðŸ‡ª Estonia (EE)</option>
            <option value="LV" selected>ðŸ‡±ðŸ‡» Latvia (LV)</option>
            <option value="LT">ðŸ‡±ðŸ‡¹ Lithuania (LT)</option>
          </select>
        </label>
        <label>Market
          <input name="market" value="DayAhead" />
        </label>
        <label>Currency
          <input name="currency" value="EUR" />
        </label>
        <label>Max charge hours
          <input name="maxChargeHours" type="number" step="0.1" value="3" />
        </label>
        <label>Max discharge hours
          <input name="maxDischargeHours" type="number" step="0.1" value="3" />
        </label>
        <label>Last price charged (c/kWh)
          <input name="lastPriceCharged" type="number" step="0.1" value="15" />
        </label>
        <label>Epsilon (c/kWh)
          <input name="epsilon" type="number" step="0.1" value="2" />
        </label>
        <button type="submit">Plan</button>
      </form>
    </div>

    <div class="chart-panel">
      <p id="summary" class="summary">Waiting to planâ€¦</p>
      <pre id="chart">WASM loading...</pre>
    </div>
  </div>

  <script src="wasm_exec.js"></script>
  <script>
    const go = new Go();
    let wasmReady = false;

    async function boot() {
      const resp = await WebAssembly.instantiateStreaming(fetch("app.wasm"), go.importObject);
      go.run(resp.instance);
      wasmReady = true;
      document.getElementById("output").textContent = "WASM ready. Submit the form to fetch & plan.";
    }
    boot().catch(err => {
      document.getElementById("output").textContent = "Failed to load WASM: " + err;
    });

    const form = document.getElementById("planner-form");
    const chart = document.getElementById("chart");
    const summary = document.getElementById("summary");

    const escapeHtml = (str) => str.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    const colorMap = {
      "[red]": "#ef4444",
      "[lime]": "#22c55e",
      "[yellow]": "#facc15",
      "[dodgerblue]": "#38bdf8",
      "[white]": "#e5e7eb",
    };
    const toHtml = (text) => {
      let html = escapeHtml(text);
      Object.entries(colorMap).forEach(([tag, color]) => {
        const safeTag = tag.replace("[", "\\[").replace("]", "\\]");
        const re = new RegExp(safeTag, "g");
        html = html.replace(re, `<span style="color:${color}">`);
      });
      html = html.replace(/\[-:-:-\]/g, "</span>");
      return html;
    };

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!wasmReady || typeof plan !== "function") {
        chart.textContent = "";
        summary.textContent = "WASM not ready.";
        return;
      }
      const data = Object.fromEntries(new FormData(form).entries());
      chart.textContent = "Planning...";
      summary.textContent = "Planning...";
      try {
        const json = await plan({
          area: data.area,
          market: data.market,
          currency: data.currency,
          maxChargeHours: parseFloat(data.maxChargeHours),
          maxDischargeHours: parseFloat(data.maxDischargeHours),
          lastPriceCharged: parseFloat(data.lastPriceCharged),
          epsilon: parseFloat(data.epsilon),
          // If you run the local proxy (go run ./cmd/proxy), the baseURL below avoids CORS issues.
          baseURL: location.origin + "/api/DayAheadPrices",
        });
        const parsed = JSON.parse(json);
        if (parsed.chart && parsed.chart.trim() !== "") {
          chart.innerHTML = toHtml(parsed.chart);
          chart.classList.remove("empty");
        } else {
          chart.textContent = "No chart returned.\nIf you see this, rebuild wasm (GOOS=js GOARCH=wasm go build -o web/app.wasm ./cmd/web) and reload.";
          chart.classList.add("empty");
        }

        const chargeCount = parsed.schedule?.charge_slots?.length ?? 0;
        const dischargeCount = parsed.schedule?.discharge_slots?.length ?? 0;
        const lastPrice = parsed.schedule?.last_price_charged;
        const epsilon = parsed.schedule?.epsilon;
        let msg = `Charge slots: ${chargeCount} | Discharge slots: ${dischargeCount}`;
        if (lastPrice != null && epsilon != null) {
          const chargeThreshold = lastPrice - epsilon;
          const dischargeThreshold = Math.min(lastPrice + epsilon, 8);
          msg += ` â€” thresholds: charge â‰¤ ${chargeThreshold.toFixed(2)}c, discharge â‰¥ ${dischargeThreshold.toFixed(2)}c`;
        }
        if (dischargeCount === 0) {
          msg += " (no prices above discharge threshold)";
        }
        summary.textContent = msg;
      } catch (err) {
        chart.textContent = "Error: " + err;
        chart.classList.add("empty");
        summary.textContent = "Plan failed.";
      }
    });
  </script>
</body>
</html>
